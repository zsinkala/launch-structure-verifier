<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Launch Structure Verifier</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #fafafa;
        }
        .status-pass { color: #059669; }
        .status-fail { color: #dc2626; }
        .status-unknown { color: #6b7280; }
    </style>
</head>
<body class="p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        async function analyzeToken(chain, address, forceRefresh = false) {
            const cleanAddress = address.trim();
            
            console.log('Analyzing:', chain, cleanAddress, 'Force refresh:', forceRefresh);
            
            const response = await fetch('http://localhost:3000/api/v1/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chain: chain,
                    address: cleanAddress,
                    options: {
                        include_holders: true,
                        max_holders: 10,
                        force_refresh: forceRefresh
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Received response:', data);
            return data;
        }

        function App() {
            const [chain, setChain] = useState("solana");
            const [address, setAddress] = useState("");
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const [forceRefresh, setForceRefresh] = useState(false);

            const handleAnalyze = async (e) => {
                e.preventDefault();
                if (!address.trim()) return;

                setLoading(true);
                setError(null);
                setResult(null);

                try {
                    const data = await analyzeToken(chain, address, forceRefresh);
                    setResult(data);
                } catch (err) {
                    setError(err.message || "Failed to analyze token. Make sure the backend server is running.");
                    console.error('Error:', err);
                } finally {
                    setLoading(false);
                }
            };

            const getGradeColor = (grade) => {
                switch(grade) {
                    case 'Strong': return 'text-green-700 bg-green-50';
                    case 'Mixed': return 'text-yellow-700 bg-yellow-50';
                    case 'Fragile': return 'text-orange-700 bg-orange-50';
                    case 'Compromised': return 'text-red-700 bg-red-50';
                    default: return 'text-gray-700 bg-gray-50';
                }
            };

            const getStatusIcon = (status) => {
                switch(status) {
                    case 'Pass': return 'âœ“';
                    case 'Fail': return 'âœ—';
                    case 'Unknown': return '?';
                    default: return 'Â·';
                }
            };

            const exampleAddresses = chain === "solana" 
                ? "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263 (BONK) or EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v (USDC)"
                : "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913 (USDC on Base)";

            return (
                <div className="max-w-4xl mx-auto">
                    <header className="mb-8">
                        <h1 className="text-3xl font-normal mb-2">Launch Structure Verifier</h1>
                        <p className="text-gray-600">Structural analysis only. No price, no prediction.</p>
                        <p className="text-xs text-gray-500 mt-2">
                            ðŸ”´ Backend: <span id="backend-status">Checking...</span>
                        </p>
                    </header>

                    <form onSubmit={handleAnalyze} className="mb-8 bg-white p-6 rounded-lg shadow-sm">
                        <div className="mb-4">
                            <label className="block text-sm font-medium mb-2">Chain</label>
                            <select 
                                value={chain} 
                                onChange={(e) => setChain(e.target.value)}
                                className="w-full p-2 border rounded"
                            >
                                <option value="solana">Solana</option>
                                <option value="base">Base</option>
                            </select>
                        </div>

                        <div className="mb-4">
                            <label className="block text-sm font-medium mb-2">Token Address</label>
                            <input
                                type="text"
                                value={address}
                                onChange={(e) => setAddress(e.target.value)}
                                placeholder="Enter token address..."
                                className="w-full p-2 border rounded font-mono text-sm"
                            />
                            <p className="text-xs text-gray-500 mt-1">
                                Try: {exampleAddresses}
                            </p>
                        </div>

                        <div className="mb-4">
                            <label className="flex items-center text-sm">
                                <input
                                    type="checkbox"
                                    checked={forceRefresh}
                                    onChange={(e) => setForceRefresh(e.target.checked)}
                                    className="mr-2"
                                />
                                Force refresh (bypass cache)
                            </label>
                        </div>

                        <button
                            type="submit"
                            disabled={loading || !address.trim()}
                            className="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                        >
                            {loading ? 'Analyzing on-chain data...' : 'Analyze'}
                        </button>
                    </form>

                    {error && (
                        <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded mb-8">
                            <strong>Error:</strong> {error}
                        </div>
                    )}

                    {result && (
                        <div className="space-y-6">
                            <div className="bg-gray-100 p-3 rounded text-xs font-mono">
                                <div>Chain: {result.chain}</div>
                                <div>Address: {result.address}</div>
                                <div>Analysis ID: {result.analysis_id}</div>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow-sm">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h2 className="text-xl font-medium">{result.token?.symbol || 'Token'}</h2>
                                        {result.token?.name && (
                                            <p className="text-sm text-gray-600">{result.token.name}</p>
                                        )}
                                    </div>
                                    <div className="text-right">
                                        <div className={`inline-block px-3 py-1 rounded font-medium ${getGradeColor(result.score.grade)}`}>
                                            {result.score.grade}
                                        </div>
                                        <div className="text-2xl font-bold mt-1">
                                            {result.score.fairness_score || 'N/A'}/100
                                        </div>
                                    </div>
                                </div>
                                <p className="text-gray-700">{result.explain.summary}</p>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow-sm">
                                <h3 className="text-lg font-medium mb-4">Structural Checks</h3>
                                <div className="space-y-3">
                                    {result.checks.map(check => (
                                        <div key={check.id} className="flex items-center justify-between py-2 border-b last:border-b-0">
                                            <div className="flex items-center">
                                                <span className={`mr-3 text-lg font-bold status-${check.status.toLowerCase()}`}>
                                                    {getStatusIcon(check.status)}
                                                </span>
                                                <div>
                                                    <div className="font-medium">{check.label}</div>
                                                    <div className="text-xs text-gray-500">
                                                        Severity: {check.severity}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                {check.score_component !== null ? (
                                                    <span className="font-mono text-sm">{check.score_component}/100</span>
                                                ) : (
                                                    <span className="text-gray-400 text-sm">N/A</span>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow-sm">
                                <h3 className="text-lg font-medium mb-4">What This Means</h3>
                                <ul className="space-y-2">
                                    {result.explain.interpretation.what_to_do.map((item, idx) => (
                                        <li key={idx} className="text-gray-700">â€¢ {item}</li>
                                    ))}
                                </ul>
                            </div>

                            <details className="bg-gray-50 p-4 rounded">
                                <summary className="cursor-pointer font-medium">How this analysis works</summary>
                                <div className="mt-3 text-sm text-gray-700 space-y-2">
                                    <p>â€¢ This tool evaluates structural fairness, not price prediction.</p>
                                    <p>â€¢ Each check is verifiable on-chain and scored transparently.</p>
                                    <p>â€¢ Unknown data does not penalize the score.</p>
                                    <p>â€¢ Critical failures (mint authority or ownership not renounced) override all other checks.</p>
                                    <p>â€¢ Data fetched directly from blockchain via Helius (Solana) or Alchemy (Base/EVM).</p>
                                </div>
                            </details>
                        </div>
                    )}
                </div>
            );
        }

        fetch('http://localhost:3000/api/v1/analyze', {method: 'OPTIONS'})
            .then(() => {
                document.getElementById('backend-status').textContent = 'Connected';
                document.getElementById('backend-status').style.color = 'green';
            })
            .catch(() => {
                document.getElementById('backend-status').textContent = 'Not running';
                document.getElementById('backend-status').style.color = 'red';
            });

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
